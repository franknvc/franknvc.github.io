<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Frank's Redily</title><link rel=stylesheet href=/css/bulma.min.css><link rel=stylesheet href=/css/style.css></head><body class=terminal><section class=window><header class=window-header><div class="logo terminal-prompt"><a href=https://franknvc.github.io/ class=no-style>Frank's Redily</a>
<span style=color:blue>:~#</span>
<a href=https://franknvc.github.io/posts>posts</a><span style=color:#1a95e0>/</span>
<a href=https://franknvc.github.io/posts/python>python</a><span style=color:#1a95e0>/</span>
<a href=https://franknvc.github.io/posts/python/profiling>profiling</a><span style=color:#1a95e0>/</span></div><div class=window-controls><span class="control-item control-minimize">‒</span>
<span class="control-item control-maximize">□</span>
<span class="control-item control-close">˟</span></div></header><main class=window-content id=content><div class=container><div class=window-cursor><span class=i-cursor-indicator>></span><div class=terminal-nav><nav class=terminal-menu><ul vocab="https://schema.org/" typeof="BreadcrumbList"><li><a href=/about typeof="ListItem">/about</a></li><li><a href=/posts typeof="ListItem">/posts</a></li><li><a href=/projects typeof="ListItem">/projects</a></li><li><a href=/gallery typeof="ListItem">/photos</a></li><li><a href=/resume typeof="ListItem">/resumé</a></li></ul></nav></div><span class=i-cursor-underscore></span></div><div class=scrollable><h1>[Python] Profiling your code</h1>Apr. 12, 2021<br><br><p>&ldquo;Why is my code taking so long to run?&rdquo; If you ever feel like your application run slugishly and taking forever to run, where do you start searching for answer?</p><p>Maybe if you are experienced, you have the knowledge of the problem at hand, and you are an expert at code review and analysing, then you maybe quick to pin point certain snippets that could be the cause of the problem. However, it can be a tedious tasks that takes a lot time and effort.</p><p>So here come some tools and techniques that will help you getting to the answer more quickly. This exploratory process is called profiling, in which you can either time a few different modules, classes, functions to see where most of the execution time is spent, or you can profile your code to get more information about the relative time spent in different functions and sub-functions.</p><p>Firstly, you need to know how to time your code. To do so, you can use something as simple as:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>from</span> time <span style=color:#f92672>import</span> time

start <span style=color:#f92672>=</span> time()
<span style=color:#75715e># your code snippets</span>
end <span style=color:#f92672>=</span> time()
<span style=color:#66d9ef>print</span>(f<span style=color:#e6db74>&#34;It tooks {end - start} seconds!&#34;</span>)
</code></pre></div><blockquote><p>If you want something for benchmarking purposes, you can use <code>timeit</code> for reasonable accurate result.</p></blockquote><p>From this you can find out the total run time of the program, and run time of each piece in isolation. Then you can compare to each other and to the total time to see if a specific piece of code can be labeled as the bottleneck.</p><p>Python has a module that gives us more information called <code>cProfile</code>. It is a C extension with reasonable overhead that makes it suitable for profiling long-running programs <a href=https://docs.python.org/3/library/profile.html>The Python Profilers</a>.</p><h2 id=cprofile>cProfile</h2><p>A <em>profile</em> is a set of statistics that describe how often and how long various parts of the program executed. You can use the <code>run()</code> method to start the profiling, simply pass what you want to profile as a string statement:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#f92672>import</span> cProfile

cProfile<span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#34;pd.Series(list(&#39;ABCDEF&#39;))&#34;</span>)

<span style=color:#75715e># you can save the result to a file</span>
<span style=color:#75715e># by specifying a filename</span>
cProfile<span style=color:#f92672>.</span>run(<span style=color:#e6db74>&#39;re.compile(&#34;foo&#34; | &#34;bar&#34;)&#39;</span>, <span style=color:#e6db74>&#39;restats)</span>
</code></pre></div><p>It can also be invoked as a script to profile another script</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>python -m cProfile <span style=color:#f92672>[</span>-o output_file<span style=color:#f92672>]</span> <span style=color:#f92672>[</span>-s sort_order<span style=color:#f92672>]</span> <span style=color:#f92672>(</span>-m module | myscript.py<span style=color:#f92672>)</span>
</code></pre></div><p>The result is:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>&gt;&gt;&gt; <span style=color:#ae81ff>258</span> <span style=color:#66d9ef>function</span> calls <span style=color:#f92672>(</span><span style=color:#ae81ff>256</span> primitive calls<span style=color:#f92672>)</span> in 0.001 seconds
Ordered by: standard name
ncalls  tottime  percall  cumtime  percall filename:lineno<span style=color:#f92672>(</span><span style=color:#66d9ef>function</span><span style=color:#f92672>)</span>
</code></pre></div><ul><li><code>primitive calls</code> are those that are not induced via recursion, and the report is sorted based on standard name, which is the text in <code>filename:lineno(function)</code> function</li><li><code>ncalls</code>: the number of calls made</li><li><code>tottime</code>: the total time spent in the given function</li><li><code>percall</code>: <code>tottime</code> divided by <code>ncalls</code></li><li><code>cumtime</code>: cummulative time spent in this and all sub-functions</li><li><code>percall</code>: <code>cumtime</code> divided by primitive calls</li><li>`filename:lineno(function): respective data of each function</li></ul><h2 id=memory-profiler>memory-profiler</h2><p>This is a python module for monitoring memory consumption of a process as well as line-by-line analysis.</p><p>Decorate the function with <code>@profile</code> then run the script with memory-profiler or from import</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-python data-lang=python><span style=color:#a6e22e>@profile</span>
<span style=color:#66d9ef>def</span> <span style=color:#a6e22e>my_function</span>()

<span style=color:#66d9ef>if</span> __name__ <span style=color:#f92672>==</span> <span style=color:#e6db74>&#39;__main__&#39;</span>:
    my_func()
</code></pre></div><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>python -m memory-profiler my-script.py
</code></pre></div><h2 id=fil---a-memory-profiler-for-data-scientists>Fil - a memory profiler for data scientists</h2><p>If your Python data pipeline is using too much memory, it can be very difficult to figure where all that memory is going.</p><h3 id=data-pipelines-and-servers>Data pipelines and servers</h3><p>A data pipeline means a batch program that reads some data, processes it, and then writes it out. The impact of memory usage is different from that of a server:</p><ul><li>Server: because it keeps running, memory leaks are common cause of memory problems. Most servers just process small amount of data at a time, so actual business logic memory usage is usually less of a concern.</li><li>Data pipelines: spikes in memory usage due to processing large chunks of data are a more common problem.</li></ul></div></div></main><footer class=bottom><small>Copyright 2021 Nguyen Viet Cuong</small></footer></section></body></html>