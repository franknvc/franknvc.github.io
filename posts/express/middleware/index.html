<!doctype html><html><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><title>Frank's Redily</title><link rel=stylesheet href=/css/bulma.min.css><link rel=stylesheet href=/css/style.css></head><body class=terminal><section class=window><header class=window-header><div class="logo terminal-prompt"><a href=https://franknvc.github.io/ class=no-style>Frank's Redily</a>
<span style=color:blue>:~#</span>
<a href=https://franknvc.github.io/posts>posts</a><span style=color:#1a95e0>/</span>
<a href=https://franknvc.github.io/posts/express>express</a><span style=color:#1a95e0>/</span>
<a href=https://franknvc.github.io/posts/express/middleware>middleware</a><span style=color:#1a95e0>/</span></div><div class=window-controls><span class="control-item control-minimize">‒</span>
<span class="control-item control-maximize">□</span>
<span class="control-item control-close">˟</span></div></header><main class=window-content id=content><div class=container><div class=window-cursor><span class=i-cursor-indicator>></span><div class=terminal-nav><nav class=terminal-menu><ul vocab="https://schema.org/" typeof="BreadcrumbList"><li><a href=/about typeof="ListItem">/about</a></li><li><a href=/posts typeof="ListItem">/posts</a></li><li><a href=/projects typeof="ListItem">/projects</a></li><li><a href=/gallery typeof="ListItem">/photos</a></li><li><a href=/resume typeof="ListItem">/resumé</a></li></ul></nav></div><span class=i-cursor-underscore></span></div><div class=scrollable><h1>[Express] Middleware - examples</h1>Apr. 13, 2021<br><br><h2 id=middleware>Middleware</h2><p>Middleware contains functions that process the request object (req) and the response (res) object between when a server receives a request and when it sends a response.</p><h2 id=using-express-middleware>Using Express middleware</h2><p>Create a new project and install <code>Express</code>. Then we are going to install the middleware using the npm:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>npm install morgan
npm install helmet
npm install cors
npm install express-rate-limit
npm install serve-favicon
</code></pre></div><p>Update <code>index.js</code> in order to use the middleware:</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-javascript data-lang=javascript><span style=color:#66d9ef>const</span> <span style=color:#a6e22e>express</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>morgan</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;morgan&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>helmet</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;helmet&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>cors</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;cors&#39;</span>);
<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>rateLimit</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;express-rate-limit&#39;</span>);
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>path</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;path&#39;</span>);
<span style=color:#66d9ef>var</span> <span style=color:#a6e22e>favicon</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>require</span>(<span style=color:#e6db74>&#39;serve-favicon&#39;</span>);

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>limiter</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>rateLimit</span>({
    <span style=color:#a6e22e>windowMs</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>15</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>60</span> <span style=color:#f92672>*</span> <span style=color:#ae81ff>1000</span>, <span style=color:#75715e>// 15 minutes
</span><span style=color:#75715e></span>    <span style=color:#a6e22e>max</span><span style=color:#f92672>:</span> <span style=color:#ae81ff>100</span>,
    <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;too many calls from this IP, please try again after 1 minute&#34;</span>
});


<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>app</span> <span style=color:#f92672>=</span> <span style=color:#a6e22e>express</span>();
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>favicon</span>(<span style=color:#a6e22e>path</span>.<span style=color:#a6e22e>join</span>(<span style=color:#a6e22e>__dirname</span>, <span style=color:#e6db74>&#39;public&#39;</span>, <span style=color:#e6db74>&#39;favicon.io&#39;</span>));
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>morgan</span>(<span style=color:#e6db74>&#34;common&#34;</span>));
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>helmet</span>());
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>cors</span>());
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>use</span>(<span style=color:#a6e22e>limiter</span>);

<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>get</span>(<span style=color:#e6db74>&#34;/&#34;</span>, (<span style=color:#a6e22e>req</span>, <span style=color:#a6e22e>res</span>) =&gt; {
    <span style=color:#a6e22e>res</span>.<span style=color:#a6e22e>json</span>({
        <span style=color:#a6e22e>message</span><span style=color:#f92672>:</span> <span style=color:#e6db74>&#34;Hello World!&#34;</span>,
    });
});

<span style=color:#66d9ef>const</span> <span style=color:#a6e22e>port</span> <span style=color:#f92672>=</span> <span style=color:#ae81ff>3000</span>;
<span style=color:#a6e22e>app</span>.<span style=color:#a6e22e>listen</span>(<span style=color:#a6e22e>port</span>, () =&gt; {
    <span style=color:#a6e22e>console</span>.<span style=color:#a6e22e>log</span>(<span style=color:#e6db74>`Listening on port: </span><span style=color:#e6db74>${</span><span style=color:#a6e22e>port</span><span style=color:#e6db74>}</span><span style=color:#e6db74>`</span>);
})
</code></pre></div><h2 id=morgan>morgan</h2><p>An HTTP request logger middleware that generates logs for each request. <code>morgan</code> contains many predefined format that you can use or you can create a new one based on your needs.</p><p>When you head over to <code>http://localhost:3000</code>, you will see a log generated in the terminal where your server is running</p><div class=highlight><pre style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash>::ffff::127.0.0.1 - - <span style=color:#f92672>[</span>13/Apr/2021:09:30:16 +0000<span style=color:#f92672>]</span> <span style=color:#e6db74>&#34;GET / HTTP/1.1&#34;</span> <span style=color:#ae81ff>304</span> -
</code></pre></div><h2 id=helmet>helmet</h2><p><code>helmet</code> is a security middleware that protects by setting HTTP headers. <code>helmet</code> is a collection of 11 small middlewares that protect your app from well-known vulnerabilities and attacks.</p><h2 id=cors>cors</h2><p><code>cors</code> stands for cross-origin resource sharing. It is used to enabled and configure CORS in express apps. It tells the server to accept request from a different origin (for e.g. client on port 8000 and express on port 3000) than the express server.</p><p><code>app.use(cors())</code> allows requests from any origin, but this can open your app to security vulnerabilities unless you have a public API which you want to accept requests from any origin.</p><p>you can create a whitelist of allowed domains and check to see if the request is from a whitelisted domain.</p><h2 id=express-rate-limit>express-rate-limit</h2><p>This is a basic rate-limiting middleware for express, that limits the repeated API requests from the same IP address.</p><p>The above code limits each IP address to 100 requests in 15-minute and a message when requests exceed 100.</p><p>Since <code>morgan</code> is still in effect, you can see in the logs in the terminal the <code>429</code> status code indicates that the user has sent too many requests in a given amount of time.</p><h2 id=serve-favicon>serve-favicon</h2><p>As its name suggests, this is a favicon serving middleware. You will see that a favicon is present on the page, and it also caches the favicon in memory to improve performance.</p></div></div></main><footer class=bottom><small>Copyright 2021 Nguyen Viet Cuong</small></footer></section></body></html>